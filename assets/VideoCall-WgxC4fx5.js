import{r as n,j as e,H as P}from"./index-eW5sAbiY.js";function T(){const[p,S]=n.useState(""),[f,j]=n.useState(""),[o,l]=n.useState("disconnected"),[I,N]=n.useState([]),[i,v]=n.useState([]),[x,h]=n.useState(""),[g,w]=n.useState(""),u=n.useRef(null),m=n.useRef(null),a=n.useRef(null),c=n.useRef(null);n.useEffect(()=>{const r=Math.random().toString(36).substring(2,10);S(r);const t=new URLSearchParams(window.location.search).get("peer");return t&&j(t),()=>{b()}},[]);const y=()=>{const r=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]});r.onicecandidate=s=>{if(s.candidate){const t=JSON.stringify(s.candidate);N(d=>[...d,t])}},r.ontrack=s=>{m.current&&(m.current.srcObject=s.streams[0])},r.onconnectionstatechange=()=>{r.connectionState==="disconnected"&&b()},a.current=r},C=async()=>{try{const r=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});return c.current=r,u.current&&(u.current.srcObject=r),r}catch(r){throw console.error("Error accessing media devices:",r),r}},k=async()=>{l("starting");try{await C(),y(),c.current&&c.current.getTracks().forEach(s=>{var t;(t=a.current)==null||t.addTrack(s,c.current)});const r=await a.current.createOffer();await a.current.setLocalDescription(r),h(JSON.stringify(r)),l("waiting-for-answer")}catch(r){console.error("Error starting call:",r),l("error")}},O=async()=>{if(!(!a.current||!x)){l("answering");try{await C(),y(),c.current&&c.current.getTracks().forEach(t=>{var d;(d=a.current)==null||d.addTrack(t,c.current)});const r=JSON.parse(x);await a.current.setRemoteDescription(new RTCSessionDescription(r));const s=await a.current.createAnswer();if(await a.current.setLocalDescription(s),w(JSON.stringify(s)),i.length>0)for(const t of i)try{await a.current.addIceCandidate(new RTCIceCandidate(JSON.parse(t)))}catch(d){console.error("Error adding ICE candidate:",d)}l("connected")}catch(r){console.error("Error answering call:",r),l("error")}}},R=async()=>{if(!(!a.current||!g))try{const r=JSON.parse(g);if(await a.current.setRemoteDescription(new RTCSessionDescription(r)),i.length>0)for(const s of i)try{await a.current.addIceCandidate(new RTCIceCandidate(JSON.parse(s)))}catch(t){console.error("Error adding ICE candidate:",t)}l("connected")}catch(r){console.error("Error applying answer:",r),l("error")}},b=()=>{a.current&&(a.current.close(),a.current=null),c.current&&(c.current.getTracks().forEach(r=>r.stop()),c.current=null),u.current&&(u.current.srcObject=null),m.current&&(m.current.srcObject=null),N([]),v([]),h(""),w(""),l("disconnected")},E=()=>{const r=`${window.location.origin}${window.location.pathname}?peer=${p}`;navigator.clipboard.writeText(r),alert(`لینک دعوت کپی شد: ${r}`)};return e.jsx("div",{className:"relative flex size-full min-h-screen flex-col bg-primary group/design-root overflow-x-hidden",style:{fontSize:"16px"},children:e.jsxs("div",{className:"flex h-full grow flex-col",children:[e.jsx(P,{}),e.jsxs("div",{className:"flex flex-col items-center justify-center p-4",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"تماس ویدیویی"}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 w-full max-w-4xl",children:[e.jsxs("div",{className:"flex-1 bg-gray-800 rounded-lg overflow-hidden",children:[e.jsx("video",{ref:u,autoPlay:!0,muted:!0,className:"w-full h-auto max-h-[400px]"}),e.jsxs("div",{className:"p-2 bg-gray-900 text-white",children:["شما (ID: ",p,")"]})]}),e.jsxs("div",{className:"flex-1 bg-gray-800 rounded-lg overflow-hidden",children:[e.jsx("video",{ref:m,autoPlay:!0,className:"w-full h-auto max-h-[400px]"}),e.jsx("div",{className:"p-2 bg-gray-900 text-white",children:o==="connected"?`مخاطب (ID: ${f})`:"در انتظار اتصال..."})]})]}),e.jsxs("div",{className:"mt-6 w-full max-w-2xl bg-gray-100 p-4 rounded-lg",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block mb-2 font-medium",children:"کد مخاطب:"}),e.jsx("input",{type:"text",value:f,onChange:r=>j(r.target.value),className:"w-full p-2 border rounded",placeholder:"کد مخاطب را وارد کنید",disabled:o!=="disconnected"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 justify-center",children:[e.jsx("button",{onClick:k,disabled:o!=="disconnected"||!f,className:"bg-blue-500 text-white px-4 py-2 rounded disabled:bg-gray-400",children:"شروع تماس"}),e.jsx("button",{onClick:E,className:"bg-green-500 text-white px-4 py-2 rounded",children:"کپی لینک دعوت"}),e.jsx("button",{onClick:b,disabled:o==="disconnected",className:"bg-red-500 text-white px-4 py-2 rounded disabled:bg-gray-400",children:"قطع تماس"})]}),o==="waiting-for-answer"&&e.jsxs("div",{className:"mt-4 p-3 bg-yellow-100 rounded",children:[e.jsx("h3",{className:"font-bold mb-2",children:"اطلاعات تماس شما:"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"block mb-1",children:"SDP Offer:"}),e.jsx("textarea",{value:x,readOnly:!0,className:"w-full p-2 border rounded bg-gray-50",rows:3})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1",children:"ICE Candidates:"}),e.jsx("textarea",{value:I.join(`

`),readOnly:!0,className:"w-full p-2 border rounded bg-gray-50",rows:3})]}),e.jsx("p",{className:"mt-2 text-sm",children:"این اطلاعات را برای مخاطب خود ارسال کنید تا آنها را در بخش زیر وارد کند."})]}),o==="waiting-for-answer"&&g&&e.jsxs("div",{className:"mt-4 p-3 bg-blue-50 rounded",children:[e.jsx("h3",{className:"font-bold mb-2",children:"پاسخ مخاطب:"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"block mb-1",children:"SDP Answer:"}),e.jsx("textarea",{value:g,onChange:r=>w(r.target.value),className:"w-full p-2 border rounded",rows:3,placeholder:"SDP Answer مخاطب را اینجا وارد کنید"})]}),e.jsx("button",{onClick:R,className:"bg-purple-500 text-white px-4 py-2 rounded mt-2",children:"اعمال پاسخ"})]}),o==="disconnected"&&f&&e.jsxs("div",{className:"mt-4 p-3 bg-blue-50 rounded",children:[e.jsx("h3",{className:"font-bold mb-2",children:"اطلاعات تماس مخاطب:"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"block mb-1",children:"SDP Offer:"}),e.jsx("textarea",{value:x,onChange:r=>h(r.target.value),className:"w-full p-2 border rounded",rows:3,placeholder:"SDP Offer مخاطب را اینجا وارد کنید"})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"block mb-1",children:"ICE Candidates:"}),e.jsx("textarea",{value:i.join(`

`),onChange:r=>v(r.target.value.split(`

`)),className:"w-full p-2 border rounded",rows:3,placeholder:"ICE Candidates مخاطب را اینجا وارد کنید (هر candidate در یک خط)"})]}),e.jsx("button",{onClick:O,className:"bg-purple-500 text-white px-4 py-2 rounded mt-2",children:"پاسخ به تماس"})]}),e.jsxs("div",{className:"mt-4 p-2 bg-gray-200 rounded",children:["وضعیت:"," ",{disconnected:"قطع",starting:"در حال شروع تماس...","waiting-for-answer":"در انتظار پاسخ مخاطب...",answering:"در حال پاسخ به تماس...",connected:"متصل",error:"خطا در اتصال"}[o]]})]})]})]})})}export{T as default};
